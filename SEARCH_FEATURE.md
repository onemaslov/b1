# Функция поиска на карте

## Обзор

Добавлена функция интеллектуального поиска на карте, которая позволяет пользователям находить места по адресу или координатам.

## Возможности

### 1. Поиск по адресу
- Ввод адреса, названия места, организации и т.д.
- Автоматические подсказки при вводе (debounce 500ms)
- Отображение до 10 наиболее релевантных результатов
- Сортировка результатов по важности
- Поддержка русского языка

### 2. Поиск по координатам
- Формат: `широта, долгота`
- Поддерживаемые форматы:
  - `55.7558, 37.6173` (с пробелом после запятой)
  - `55.7558,37.6173` (без пробела)
  - `55.7558 37.6173` (через пробел)
- Автоматическая валидация диапазонов:
  - Широта: -90 до 90
  - Долгота: -180 до 180
- Мгновенная установка метки по Enter

### 3. Автоматическое действие
- При выборе места карта центрируется на координатах
- Устанавливается временный маркер (красный круг)
- Автоматически открывается окно добавления постоянной метки
- Загружается информация об адресе

## Компоненты

### SearchBar Component (`src/components/SearchBar.tsx`)

Основной компонент поиска с поддержкой:
- Debouncing для запросов к API
- Парсинг координат различных форматов
- Dropdown с результатами поиска
- Визуальная обратная связь (loader, подсказки, ошибки)
- Закрытие при клике вне компонента

#### Props
```typescript
interface SearchBarProps {
  onLocationSelect: (lat: number, lng: number, addMarker?: boolean) => void
}
```

#### Основные методы
- `parseCoordinates(text: string)` - парсинг координат из текста
- `searchAddress(searchQuery: string)` - поиск адресов через API
- `handleQueryChange(value: string)` - обработка ввода с debounce
- `handleSubmit(e: React.FormEvent)` - обработка Enter
- `handleResultSelect(result: SearchResult)` - выбор из списка

### API Endpoint (`src/app/api/geocode/route.ts`)

REST API для геокодирования адресов через Nominatim OpenStreetMap.

#### Endpoint
```
GET /api/geocode?q=<поисковый запрос>
```

#### Параметры запроса
- `q` (обязательный) - поисковый запрос (минимум 3 символа)

#### Ответ
```typescript
{
  results: GeocodingResult[],
  count: number
}

interface GeocodingResult {
  display_name: string      // Полное название
  lat: string              // Широта
  lon: string              // Долгота
  type?: string            // Тип объекта
  importance?: number      // Важность (для сортировки)
  class?: string           // Класс объекта
  address?: {              // Детали адреса
    road?: string
    city?: string
    country?: string
    // ... другие поля
  }
}
```

#### Особенности
- Использует Nominatim API OpenStreetMap
- Лимит: 10 результатов
- Язык: русский (accept-language=ru)
- Автоматическая сортировка по важности
- User-Agent: MapMarkersApp/1.0

## Интеграция в приложение

### Главная страница (`src/app/page.tsx`)

Добавлены:
1. Импорт компонента `SearchBar`
2. State для центрирования карты: `centerTo`
3. Обработчик `handleSearchLocationSelect`:
   - Устанавливает выбранную точку
   - Центрирует карту
   - Получает информацию об адресе (reverse geocoding)
   - Открывает модальное окно для добавления метки

### Компонент карты (`src/components/Map.tsx`)

Добавлены:
1. Новый prop `centerTo?: { lat: number; lng: number; zoom?: number }`
2. useEffect для программного центрирования карты
3. Ref для отслеживания предыдущей позиции (избежание лишних центрирований)

## Пользовательский опыт (UX)

### Интерфейс
- Поле поиска расположено в верхней части экрана под заголовком
- Максимальная ширина: 640px (w-full max-w-xl)
- Иконка поиска слева
- Кнопка очистки справа (появляется при вводе)
- Loader при загрузке результатов

### Подсказки
- Для координат: "Нажмите Enter для установки метки по координатам"
- При отсутствии результатов: "Ничего не найдено"
- При ошибке: текст ошибки в красной плашке

### Dropdown результатов
- Максимальная высота: 384px (max-h-96)
- Прокрутка при большом количестве результатов
- Hover эффект для каждого элемента
- Иконка MapPin для каждого результата
- Название + тип объекта

### Анимации
- Плавное появление/скрытие dropdown
- Smooth scroll при центрировании карты
- Transition для hover эффектов

## Примеры использования

### Поиск достопримечательности
```
Ввод: "Эрмитаж"
Результат: Список музеев Эрмитаж в разных городах
Действие: Клик → центрирование + метка
```

### Поиск по адресу
```
Ввод: "Невский проспект, 1"
Результат: Список адресов с этим названием
Действие: Клик → центрирование + метка
```

### Поиск по координатам
```
Ввод: "59.9343, 30.3351"
Результат: Подсказка "Нажмите Enter"
Действие: Enter → центрирование + модальное окно метки
```

## Технические детали

### Debouncing
- Задержка: 500ms
- Предотвращает лишние запросы к API
- Сбрасывается при каждом новом вводе

### Обработка ошибок
- Catch всех ошибок fetch
- Вывод пользовательских сообщений
- Логирование в консоль для отладки

### Оптимизация
- Минимальная длина запроса: 3 символа
- Автоматическое закрытие dropdown при выборе
- Ref для предотвращения лишних рендеров
- useCallback для стабильности функций

### API лимиты
- Nominatim имеет rate limit: 1 запрос в секунду
- Debounce помогает соблюдать это ограничение
- Рекомендуется не убирать/уменьшать debounce

## Будущие улучшения

### Возможные дополнения:
1. История последних поисков (localStorage)
2. Избранные места (сохранение в БД)
3. Категории поиска (рестораны, отели, музеи и т.д.)
4. Поиск в радиусе от текущего местоположения
5. Поддержка других форматов координат (DMS, UTM)
6. Кэширование частых запросов
7. Поиск среди собственных меток
8. Голосовой ввод

### Оптимизации:
1. Использование другого geocoding API (например, Mapbox)
2. Кэш на стороне сервера (Redis)
3. Предзагрузка популярных результатов
4. Индексирование для быстрого поиска

## Troubleshooting

### Поиск не работает
1. Проверьте доступность Nominatim API
2. Убедитесь, что запрос содержит минимум 3 символа
3. Проверьте консоль на наличие ошибок

### Медленная работа
1. Увеличьте debounce (но не более 1000ms)
2. Уменьшите лимит результатов в API
3. Проверьте скорость интернет-соединения

### Неточные результаты
1. Уточните запрос (добавьте город, страну)
2. Попробуйте использовать координаты
3. Nominatim может не знать о новых объектах

## Связанные файлы

- `src/components/SearchBar.tsx` - компонент поиска
- `src/app/api/geocode/route.ts` - API endpoint
- `src/app/page.tsx` - интеграция в главную страницу
- `src/components/Map.tsx` - обновления карты
- `src/lib/geocoding.ts` - вспомогательные функции геокодирования
- `README.md` - обновленная документация

